<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RT Digital Master - KamikazeNow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { color: #2563eb; transform: scale(1.1); font-weight: 800; border-bottom: 3px solid #2563eb; }
    </style>
</head>
<body class="bg-slate-50 pb-24 text-slate-900">
    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import React, { useState, useEffect, useMemo } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

        const firebaseConfig = {
            apiKey: "AIzaSyBj-_EGJRpAwrRgun73XBYuu5PiRbrK7ys",
            authDomain: "studio-1050598195-55970.firebaseapp.com",
            projectId: "studio-1050598195-55970",
            storageBucket: "studio-1050598195-55970.firebasestorage.app",
            messagingSenderId: "1013859380643",
            appId: "1:1013859380643:web:c58802427b5c1bfee63e16"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        function App() {
            const [tab, setTab] = useState('kas');
            const [transactions, setTransactions] = useState([]);
            const [loans, setLoans] = useState([]);
            const [arisans, setArisans] = useState([]);
            const [user, setUser] = useState(null);
            const [delModal, setDelModal] = useState({ show: false, id: null, coll: null });

            useEffect(() => {
                signInAnonymously(auth);
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                onSnapshot(collection(db, "kas_rt"), s => setTransactions(s.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(collection(db, "pinjaman_rt"), s => setLoans(s.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(collection(db, "arisan_rt"), s => setArisans(s.docs.map(d => ({id: d.id, ...d.data()}))));
            }, [user]);

            const ledgerData = useMemo(() => {
                const sorted = [...transactions].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime() || (a.timestamp || 0) - (b.timestamp || 0));
                let bal = 0;
                return sorted.map(t => {
                    bal = t.type === 'income' ? bal + t.amount : bal - t.amount;
                    return { ...t, runningBal: bal };
                });
            }, [transactions]);

            const summary = useMemo(() => {
                const inc = transactions.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
                const exp = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);
                const activeL = loans.filter(l => !l.lunas).reduce((s, l) => s + (l.sisa || 0), 0);
                return { inc, exp, bal: inc - exp, activeL };
            }, [transactions, loans]);

            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const docPdf = new jsPDF();
                docPdf.setFontSize(16);
                docPdf.text("LAPORAN KAS & PINJAMAN RT", 105, 15, { align: "center" });

                docPdf.autoTable({
                    startY: 25,
                    head: [['Katerangan', 'Jumlah']],
                    body: [
                        ['Total Masuk', `Rp ${summary.inc.toLocaleString()}`],
                        ['Total Keluar', `Rp ${summary.exp.toLocaleString()}`],
                        ['SALDO AKHIR', `Rp ${summary.bal.toLocaleString()}`],
                        ['Sisa Pinjaman Aktif', `Rp ${summary.activeL.toLocaleString()}`]
                    ],
                    theme: 'grid'
                });

                docPdf.text("I. RIWAYAT KAS (SALDO BERJALAN)", 14, docPdf.lastAutoTable.finalY + 12);
                docPdf.autoTable({
                    startY: docPdf.lastAutoTable.finalY + 15,
                    head: [['Tgl', 'Ket', 'Masuk', 'Metu', 'Saldo']],
                    body: ledgerData.map(t => [t.date, t.description, t.type==='income' ? t.amount.toLocaleString() : '0', t.type==='expense' ? t.amount.toLocaleString() : '0', t.runningBal.toLocaleString()]),
                    headStyles: { fillColor: [37, 99, 235] },
                    styles: { fontSize: 8 }
                });

                docPdf.text("II. DAFTAR PINJAMAN & RIWAYAT CICILAN", 14, docPdf.lastAutoTable.finalY + 12);
                const loanRows = loans.map(l => {
                    const cicilan = transactions
                        .filter(t => t.description && t.description.includes(`Nyicil: ${l.nama}`))
                        .sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime())
                        .map(t => `${t.date}`)
                        .join(', ');
                    
                    let st = l.lunas ? 'LUNAS' : (l.isMacet ? 'MACET' : 'AKTIF');
                    return [`${l.nama}\n(Tgl: ${l.date})`, l.total.toLocaleString(), l.sisa.toLocaleString(), cicilan || '-', st];
                });

                docPdf.autoTable({
                    startY: docPdf.lastAutoTable.finalY + 15,
                    head: [['Nama & Tgl Pinjam', 'Total+Bunga', 'Sisa Tagihan', 'Tgl Cicilan', 'Status']],
                    body: loanRows,
                    headStyles: { fillColor: [51, 65, 85] },
                    styles: { fontSize: 7 },
                    didParseCell: (d) => {
                        if (d.column.index === 4) {
                            if (d.cell.raw === 'MACET') d.cell.styles.textColor = [220, 38, 38];
                            if (d.cell.raw === 'LUNAS') d.cell.styles.textColor = [22, 163, 74];
                        }
                    }
                });
                docPdf.save(`Laporan_RT.pdf`);
            };

            const doDelete = async () => {
                const { id, coll } = delModal;
                await deleteDoc(doc(db, coll, id));
                setDelModal({ show: false, id: null, coll: null });
            };

            if(!user) return null;

            return React.createElement('div', { className: 'max-w-md mx-auto min-h-screen relative bg-slate-50' }, [
                React.createElement('header', { className: 'bg-white p-6 border-b flex justify-between items-center sticky top-0 z-30 shadow-sm' }, [
                    React.createElement('div', null, [
                        React.createElement('h1', { className: 'font-black text-xl text-slate-800 uppercase' }, tab),
                        React.createElement('p', { className: 'text-[9px] font-bold text-blue-600 uppercase' }, 'KamikazeNow Digital')
                    ]),
                    React.createElement('button', { onClick: downloadPDF, className: 'bg-blue-600 text-white p-2 px-5 rounded-2xl text-[10px] font-black shadow-lg' }, 'PDF')
                ]),

                tab === 'kas' && React.createElement(KasUI, { summary, ledgerData, db, setDelModal }),
                tab === 'pinjam' && React.createElement(PinjamUI, { loans, db, setDelModal }),
                tab === 'arisan' && React.createElement(ArisanUI, { arisans, db, setDelModal }),

                React.createElement('nav', { className: 'fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t flex justify-around py-3 z-40' }, [
                    { id: 'kas', icon: 'ðŸ’°', l: 'Kas RT' }, { id: 'pinjam', icon: 'ðŸ¤', l: 'Pinjaman' }, { id: 'arisan', icon: 'ðŸŽ', l: 'Arisan' }
                ].map(n => React.createElement('button', { key: n.id, onClick: () => setTab(n.id), className: `flex flex-col items-center flex-1 transition-all ${tab === n.id ? 'active-tab' : 'text-slate-300 opacity-60'}` }, [
                    React.createElement('span', { className: 'text-xl' }, n.icon),
                    React.createElement('span', { className: 'text-[10px] font-bold mt-1' }, n.l)
                ]))),

                delModal.show && React.createElement('div', { className: 'fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-8' }, [
                    React.createElement('div', { className: 'bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-center animate-in zoom-in duration-200 shadow-2xl' }, [
                        React.createElement('div', { className: 'w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold' }, '!'),
                        React.createElement('h4', { className: 'font-black text-lg mb-2' }, 'Yakin mbusak?'),
                        React.createElement('button', { onClick: doDelete, className: 'w-full py-4 bg-red-600 text-white rounded-2xl font-black mb-2 shadow-lg shadow-red-200' }, 'IYO, HAPUS'),
                        React.createElement('button', { onClick: () => setDelModal({show:false, id:null, coll:null}), className: 'w-full py-4 text-slate-400 font-bold' }, 'BATAL')
                    ])
                ])
            ]);
        }

        function KasUI({ summary, ledgerData, db, setDelModal }) {
            const [desc, setDesc] = useState(''); const [amt, setAmt] = useState('');
            const [dt, setDt] = useState(new Date().toISOString().split('T')[0]); const [type, setType] = useState('income');
            const save = async (e) => {
                e.preventDefault(); if(!desc || !amt) return;
                await addDoc(collection(db, "kas_rt"), { description: desc, amount: Number(amt), type, date: dt, timestamp: Date.now() });
                setDesc(''); setAmt('');
            };
            return React.createElement('div', { className: 'p-4 pb-12' }, [
                React.createElement('div', { className: 'bg-slate-800 rounded-[2.5rem] p-8 text-white mb-6 shadow-xl' }, [
                    React.createElement('p', { className: 'text-[10px] font-bold opacity-40 mb-1 uppercase' }, 'Saldo Saiki'),
                    React.createElement('h2', { className: 'text-3xl font-black' }, `Rp ${summary.bal.toLocaleString()}`)
                ]),
                React.createElement('form', { onSubmit: save, className: 'bg-white p-6 rounded-3xl border mb-8 shadow-sm text-xs' }, [
                    React.createElement('div', { className: 'flex gap-2 mb-4 bg-slate-100 p-1 rounded-xl' }, [{id:'income', l:'MASUK'}, {id:'expense', l:'METU'}].map(b => React.createElement('button', { key: b.id, type:'button', onClick:()=>setType(b.id), className:`flex-1 py-2 rounded-lg font-black transition ${type === b.id ? 'bg-white shadow text-slate-800' : 'text-slate-400'}` }, b.l))),
                    React.createElement('input', { type:'date', value:dt, onChange:e=>setDt(e.target.value), className:'w-full mb-2 p-3 bg-slate-50 rounded-xl outline-none font-bold' }),
                    React.createElement('input', { placeholder:'Katerangan...', value:desc, onChange:e=>setDesc(e.target.value), className:'w-full mb-2 p-3 bg-slate-50 rounded-xl outline-none' }),
                    React.createElement('input', { type:'number', placeholder:'Jumlah Rp...', value:amt, onChange:e=>setAmt(e.target.value), className:'w-full mb-4 p-3 bg-slate-50 rounded-xl outline-none font-black' }),
                    React.createElement('button', { type:'submit', className:`w-full py-3 rounded-xl font-black text-white ${type === 'income' ? 'bg-blue-600' : 'bg-red-600'}` }, 'SIMPEN DATA')
                ]),
                React.createElement('div', { className: 'space-y-4' }, ledgerData.slice().reverse().map(item => React.createElement('div', { key: item.id, className: 'bg-white p-5 rounded-[2rem] border relative' }, [
                    React.createElement('button', { onClick: () => setDelModal({show:true, id:item.id, coll:'kas_rt'}), className: 'absolute top-0 right-0 p-5 text-red-200 font-bold' }, 'Ã—'),
                    React.createElement('div', { className: 'flex justify-between items-start mb-2 pr-6' }, [
                        React.createElement('div', null, [React.createElement('p', { className: 'font-bold text-sm text-slate-800' }, item.description), React.createElement('p', { className: 'text-[9px] font-bold text-slate-400' }, item.date)]),
                        React.createElement('p', { className: `font-black text-sm ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}` }, `${item.type==='income'?'+':'-'} ${item.amount.toLocaleString()}`)
                    ]),
                    React.createElement('div', { className: 'border-t border-slate-50 pt-2 flex justify-between' }, [React.createElement('span', { className: 'text-[8px] font-black text-slate-300 uppercase' }, 'Saldo'), React.createElement('span', { className: 'text-[10px] font-black text-blue-600' }, `Rp ${item.runningBal.toLocaleString()}`)])
                ])))
            ]);
        }

        function PinjamUI({ loans, db, setDelModal }) {
            const [n, setN] = useState(''); const [a, setA] = useState(''); const [dt, setDt] = useState(new Date().toISOString().split('T')[0]);
            const [isDH, setIsDH] = useState(false); const [sel, setSel] = useState(null); const [pAmt, setPAmt] = useState(''); const [pDt, setPDt] = useState(new Date().toISOString().split('T')[0]);
            
            const startL = async (e) => {
                e.preventDefault(); if(!n || !a) return;
                const tot = Number(a) + (Number(a) * 0.05);
                await addDoc(collection(db, "pinjaman_rt"), { nama: n, pokok: Number(a), total: tot, sisa: tot, lunas: false, date: dt, isMacet: false, isBlacklist: isDH, timestamp: Date.now() });
                if(!isDH) await addDoc(collection(db, "kas_rt"), { description: `Pinjam: ${n}`, amount: Number(a), type: 'expense', date: dt, timestamp: Date.now() });
                setN(''); setA(''); setIsDH(false);
            };

            const pay = async () => {
                if(!pAmt || !sel) return;
                const newS = sel.sisa - Number(pAmt); const lunas = newS <= 0;
                await updateDoc(doc(db, "pinjaman_rt", sel.id), { sisa: newS < 0 ? 0 : newS, lunas: lunas, isMacet: lunas ? false : sel.isMacet });
                await addDoc(collection(db, "kas_rt"), { description: `Nyicil: ${sel.nama}`, amount: Number(pAmt), type: 'income', date: pDt, timestamp: Date.now() });
                setPAmt(''); setSel(null);
            };

            return React.createElement('div', { className: 'p-4 pb-12' }, [
                React.createElement('form', { onSubmit: startL, className: 'bg-blue-600 p-6 rounded-3xl text-white mb-8 shadow-xl text-xs font-bold' }, [
                    React.createElement('input', { type:'date', value:dt, onChange:e=>setDt(e.target.value), className:'w-full mb-2 p-3 bg-white/10 rounded-xl outline-none text-white border-none' }),
                    React.createElement('input', { placeholder:'Jeneng...', value:n, onChange:e=>setN(e.target.value), className:'w-full mb-2 p-3 bg-white/10 rounded-xl outline-none text-white' }),
                    React.createElement('input', { type:'number', placeholder:'Jumlah Rp...', value:a, onChange:e=>setA(e.target.value), className:'w-full mb-3 p-3 bg-white/10 rounded-xl outline-none text-white font-black' }),
                    React.createElement('label', { className: 'flex items-center gap-2 mb-4 p-2 bg-red-500/20 rounded-xl cursor-pointer' }, [React.createElement('input', { type: 'checkbox', checked: isDH, onChange: e => setIsDH(e.target.checked), className: 'w-4 h-4' }), React.createElement('span', { className: 'text-[9px] uppercase' }, 'Daftar Hitam (Ora nyuda Kas)')]),
                    React.createElement('button', { className:'w-full py-3 bg-white text-blue-600 rounded-xl font-black' }, 'GAWE PINJAMAN')
                ]),
                React.createElement('div', { className: 'space-y-4' }, loans.map(l => React.createElement('div', { key: l.id, className: `bg-white p-6 rounded-[2.5rem] border shadow-sm relative ${l.lunas ? 'border-green-100 bg-green-50/20' : (l.isMacet ? 'border-red-500 bg-red-50' : 'border-slate-100')}` }, [
                    React.createElement('button', { onClick: () => setDelModal({show:true, id:l.id, coll:'pinjaman_rt'}), className: 'absolute top-0 right-0 p-6 text-slate-200 font-bold' }, 'Ã—'),
                    React.createElement('div', { className: 'flex justify-between mb-4 pr-6' }, [
                        React.createElement('div', null, [React.createElement('p', { className: 'font-black text-sm text-slate-800' }, [l.nama, l.isBlacklist && ' âš« DH']), React.createElement('p', { className: 'text-[9px] font-bold text-slate-400 uppercase' }, l.date || '-')]),
                        l.lunas ? React.createElement('span', { className: 'p-1 px-4 rounded-full text-[8px] font-black bg-green-100 text-green-600' }, 'LUNAS') :
                        React.createElement('button', { onClick: () => updateDoc(doc(db, "pinjaman_rt", l.id), { isMacet: !l.isMacet }), className: `p-1 px-4 rounded-full text-[8px] font-black ${l.isMacet ? 'bg-red-600 text-white' : 'bg-slate-100 text-slate-400'}` }, l.isMacet ? 'MACET' : 'NORMAL')
                    ]),
                    !l.lunas && React.createElement('div', { className: 'flex justify-between items-end border-t border-slate-50 pt-4' }, [React.createElement('div', null, [React.createElement('p', { className: 'text-[9px] font-bold text-slate-300 uppercase mb-1' }, 'Sisa Tagihan'), React.createElement('p', { className: `font-black text-sm ${l.isMacet ? 'text-red-600' : 'text-blue-600'}` }, `Rp ${l.sisa.toLocaleString()}`)]), React.createElement('button', { onClick:()=>setSel(l), className: 'bg-slate-800 text-white p-2.5 px-6 rounded-2xl text-[10px] font-black' }, 'NYICIL')])
                ]))),
                sel && React.createElement('div', { className: 'fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end' }, [
                    React.createElement('div', { className: 'bg-white w-full rounded-t-[3rem] p-10 shadow-2xl animate-in slide-in-from-bottom' }, [
                        React.createElement('h4', { className: 'font-black text-lg mb-8 text-center' }, `Nyicil: ${sel.nama}`),
                        React.createElement('input', { type:'date', value:pDt, onChange:e=>setPDt(e.target.value), className:'w-full mb-4 p-5 bg-slate-100 rounded-3xl outline-none text-center font-bold' }),
                        React.createElement('input', { type:'number', autoFocus:true, placeholder:'Jumlah Rp...', value:pAmt, onChange:e=>setPAmt(e.target.value), className:'w-full mb-8 p-5 bg-slate-100 rounded-3xl outline-none text-center text-2xl font-black' }),
                        React.createElement('div', { className: 'flex gap-3' }, [React.createElement('button', { onClick:()=>setSel(null), className: 'flex-1 py-4 font-black text-slate-400' }, 'BATAL'), React.createElement('button', { onClick:pay, className: 'flex-1 py-5 bg-blue-600 text-white rounded-[2rem] font-black' }, 'BAYAR')])
                    ])
                ])
            ]);
        }

        function ArisanUI({ arisans, db, setDelModal }) {
            const [n, setN] = useState(''); const [a, setA] = useState(''); const [dt, setDt] = useState(new Date().toISOString().split('T')[0]);
            const add = async (e) => {
                e.preventDefault(); if(!n || !a) return;
                await addDoc(collection(db, "arisan_rt"), { pemenang: n, total: Number(a), date: dt, timestamp: Date.now() });
                setN(''); setA('');
            };
            return React.createElement('div', { className: 'p-4' }, [
                React.createElement('form', { onSubmit: add, className: 'bg-purple-600 p-6 rounded-3xl text-white mb-8 shadow-xl text-xs font-bold' }, [
                    React.createElement('input', { type:'date', value:dt, onChange:e=>setDt(e.target.value), className:'w-full mb-2 p-3 bg-white/20 rounded-xl outline-none text-white border-none' }),
                    React.createElement('input', { placeholder:'Pemenang...', value:n, onChange:e=>setN(e.target.value), className:'w-full mb-2 p-3 bg-white/20 rounded-xl outline-none text-white' }),
                    React.createElement('input', { type:'number', placeholder:'Total Rp...', value:a, onChange:e=>setA(e.target.value), className:'w-full mb-4 p-3 bg-white/20 rounded-xl outline-none text-white font-black' }),
                    React.createElement('button', { className:'w-full py-3 bg-white text-purple-600 rounded-xl font-black' }, 'SIMPEN')
                ]),
                React.createElement('div', { className: 'space-y-3' }, arisans.map(item => React.createElement('div', { key: item.id, className: 'bg-white p-5 rounded-3xl border flex justify-between items-center shadow-sm relative' }, [
                    React.createElement('button', { onClick: () => setDelModal({show:true, id:item.id, coll:'arisan_rt'}), className: 'absolute top-0 right-0 p-4 text-slate-200 active:text-red-500 font-bold' }, 'Ã—'),
                    React.createElement('div', null, [React.createElement('p', { className: 'text-[8px] font-black text-purple-500 uppercase mb-1' }, item.date), React.createElement('p', { className: 'font-black text-xs text-slate-800 pr-8' }, item.pemenang)]),
                    React.createElement('p', { className: 'font-black text-xs text-slate-700' }, `Rp ${item.total.toLocaleString()}`)
                ])))
            ]);
        }
        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>

